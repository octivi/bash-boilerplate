---
# SPDX-FileCopyrightText: 2025-2026  IMAGIN sp. z o.o.
# SPDX-FileContributor: Marcin Engelmann <mengelmann@octivi.com>
# SPDX-License-Identifier: MIT
#
# This file is part of the configuration created by Octivi's DevOps team.
# Details at https://octivi.com/devops
#
# Be sure to enable "Allow GitHub Actions to create and approve pull requests" in
# the repository settings under "Actions" -> "General".
#
# In a public repository, if there is no activity for 60 days, GitHub may
# automatically disable on: schedule execution.
#
# Cron in Actions may be delayed (does not guarantee execution to the minute).
name: Update year header (scheduled PR)

on:
  schedule:
    - cron: "15 2 6 1 *" # Jan 5th, 02:15 UTC
  workflow_dispatch:
    inputs:
      targets:
        description: "Directories to scan (space-separated), e.g. '. src scripts'"
        required: false
        default: "."
      exclude_paths:
        description: "Paths to exclude (space-separated), e.g. '.github/workflows build'"
        required: false
        default: ".github/workflows"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: update-year-header
  cancel-in-progress: true

jobs:
  update-year:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Update year headers
        shell: bash
        run: |
          set -o errexit -o nounset -o pipefail
          IFS=$'\n\t'

          current_year="$(date +%Y)"
          targets="${{ github.event.inputs.targets || '.' }}"
          exclude_paths="${{ github.event.inputs.exclude_paths || '.github/workflows' }}"

          read -r -a DIRS <<< "${targets}"
          read -r -a EXCLUDES <<< "${exclude_paths}"

          prune_args=()
          for exclude in "${EXCLUDES[@]}"; do
            prune_args+=(-path "./${exclude}" -prune -o)
          done

          for dir in "${DIRS[@]}"; do
            [[ -d "${dir}" ]] || continue

            find "${dir}" "${prune_args[@]}" -type f -print0 | while IFS= read -r -d '' file; do
              if [[ "$(file --mime-type --brief "${file}")" == text/* ]]; then
                # 1) Update: YYYY or YYYY-YYYY -> YYYY-<current_year>
                sed \
                  --regexp-extended \
                  --in-place \
                  "s/^(.*Copyright.*)([0-9]{4})(-[0-9]{4})?(  IMAGIN [sS]p\. z o\.o\.)$/\1\2-${current_year}\4/" \
                  "${file}"

                # 2) Guard: collapse YYYY-YYYY back to YYYY (prevents 2025-2025)
                sed \
                  --regexp-extended \
                  --in-place \
                  "s/^(.*Copyright.*)([0-9]{4})-\2(  IMAGIN [sS]p\. z o\.o\.)$/\1\2\3/" \
                  "${file}"
              fi
            done
          done

          if git diff --quiet; then
            echo "No changes detected."
            exit 0
          fi

          git diff --stat

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          branch: update-year-header
          delete-branch: true
          commit-message: "chore: Update year header"
          title: "chore: Update year header"
          body: |
            Automated update of year headers.
          labels: |
            automation
            maintenance
